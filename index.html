<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Udacity todos/goals App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
    <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>


</head>
<body>

    <div id="app"></div>
    <script>

        // UI code
        function generateId () {
            return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
        }
        const
        ADD_GOAL = 'ADD_GOAL',
        REMOVE_GOAL = 'REMOVE_GOAL',
        ADD_TODO = 'ADD_TODO',
        REMOVE_TODO = 'REMOVE_TODO',
        TOGGLE_TODO = 'TOGGLE_TODO';

        function addTodoAction (todo) {
            return {
                type:ADD_TODO,
                todo
            }
        }
        function removeTodoAction (id) {
            return {
                type:REMOVE_TODO,
                id
            }
        }
        function toggleTodoAction (id) {
            return {
                type:TOGGLE_TODO,
                id
            }
        }

        function addGoalAction (goal) {
            return {
                type:ADD_GOAL,
                goal
            }
        }
        function removeGoalAction (id) {
            return {
                type:REMOVE_GOAL,
                id
            }
        }


        function todos (state = [], action) {
            switch (action.type) {
                case ADD_TODO:
                    return [...state, action.todo];
                case REMOVE_TODO:
                    return state.filter(todo => todo.id !== action.id)
                case TOGGLE_TODO:
                    return state.map(todo => todo.id !== action.id? todo
                        :{...todo, complete : !todo.complete})
                default:
                    return state

            }
        }

        function goals (state = [], action) {
            switch (action.type) {
                case ADD_GOAL:
                    return [...state, action.goal]
                case REMOVE_GOAL:
                    return state.filter(goal => goal.id !== action.id)
                default:
                    return state
            }
        }

        // Middleware example

        const checker = (store) => (next) => (action) => {
            if(
                action.type === ADD_TODO
                && action.todo.title.toLowerCase().includes('bitcoin')
            ) {
                return alert("Nope this is a bad idea")
            }
            if(
                action.type === ADD_GOAL
                && action.goal.title.toLowerCase().includes('bitcoin')
            ) {
                return alert("Nope this is a bad idea")
            }

            return next(action);
        }

        const logger = (store) => (next) => (action) => {
            console.group(action.type)
                console.log('The action is: ',action)
                const result = next(action);
                console.log('The new state is: ', store.getState())
            console.groupEnd()

            return result
        }

        // Create store using Redux and compined reducers

        const store = Redux.createStore(Redux.combineReducers({
            todos,
            goals
        }), Redux.applyMiddleware(checker, logger))

    </script>
    <script type="text/babel">
        const List = (props) =>{
            return (
                <ul>
                   { props.list.map(item => (
                       <li
                       key={item.id}>
                       <span
                       style={{
                           textDecoration : item.complete? 'line-through' : 'none'
                       }}
                       onClick={()=>props.toggle && props.toggle(item.id)}>{item.title}</span>
                       <button
                       onClick={()=>props.remove(item)}>
                        X
                        </button>
                       </li>
                    )) }
                </ul>
            )
        }
        class Todos extends React.Component{
            addTodo = (e) => {
                e.preventDefault()
                const title = this.input.value;
                this.input.value = ''
                this.props.store.dispatch( addTodoAction({
                    title,
                    complete:false,
                    id:generateId()
                }))
            }
            removeItem = (todo) =>{
                this.props.store.dispatch(removeTodoAction(todo.id))
            }
            toggleItem = (id) => {
                this.props.store.dispatch(toggleTodoAction(id))
            }
            render () {
                return (
                    <div>
                        <h2>TODOS
                        </h2>
                        <input
                        type="text"
                        name="title"
                        placeholder="type todo"
                        ref={input => this.input = input}
                        id="" />
                        <button
                        onClick={this.addTodo}>Add todo</button>
                        <List toggle={this.toggleItem} remove={this.removeItem} list={this.props.todos} />
                    </div>
                )
            }
        }
        class Goals extends React.Component{
            addGoal = (e) =>{
                e.preventDefault()
                const title = this.input.value
                this.input.value = ''

                this.props.store.dispatch(addGoalAction({
                    title,
                    id: generateId()
                }))
            }
            removeItem = (goal) =>{
                this.props.store.dispatch(removeGoalAction(goal))
            }
            render(){
                return (
                    <div>
                        <h2>GOALS</h2>
                        <input type="text"
                        name=""
                        placeholder="Add Goal"
                        ref={input => this.input = input}
                        id="" />
                        <button onClick={this.addGoal}> Add Goal</button>
                        <List remove={this.removeItem} list={this.props.goals} />
                    </div>
                )
            }
        }

        class App extends React.Component{
            componentDidMount(){
                const {store} = this.props;
                store.subscribe(()=> this.forceUpdate())
            }
            render (){
                const {todos , goals } = this.props.store.getState();
                return (
                    <div>
                        <Todos todos={todos} store={this.props.store}/>
                        <Goals goals={goals} store={this.props.store} />
                    </div>
                )
            }
        }

        ReactDOM.render(<App store={store}/>, document.getElementById('app'));
    </script>
</body>
</html>